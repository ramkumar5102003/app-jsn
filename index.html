<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∞≤‡∞≤‡∞ø‡∞§ ‡∞∂‡±ç‡∞∞‡±Ä ‡∞ü‡±à‡∞≤‡∞∞‡±ç‡∞∏‡±ç</title>
    <script src="cordova.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Telugu:wght@400;700&display=swap');
        
        body { font-family: 'Noto Sans Telugu', sans-serif; background-color: #F5F5F5; margin: 0; padding: 10px; color: #212121; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
        
        /* ‡∞≤‡±ã‡∞°‡∞ø‡∞Ç‡∞ó‡±ç ‡∞∏‡±ç‡∞ï‡±ç‡∞∞‡±Ä‡∞®‡±ç */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        #loader img { max-width: 150px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* ‡∞≤‡∞æ‡∞ï‡±ç ‡∞∏‡±ç‡∞ï‡±ç‡∞∞‡±Ä‡∞®‡±ç (Lock Screen) */
        #lock-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:#D32F2F; z-index: 9998; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; padding: 20px;}
        .lock-box { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 85%; max-width: 350px; color: #212121;}
        .lock-box input { width: 100%; padding: 12px; font-size: 20px; text-align: center; border: 2px solid #ccc; border-radius: 8px; margin-bottom: 15px; letter-spacing: 5px; font-weight: bold;}
        .btn-unlock { width: 100%; padding: 12px; background: #2E7D32; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; font-family: 'Noto Sans Telugu', sans-serif;}

        /* ‡∞π‡±Ü‡∞°‡∞∞‡±ç */
        .header { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; position: relative; }
        .header img { max-height: 70px; }
        .shop-name { color: #D32F2F; font-size: 22px; font-weight: bold; margin: 5px 0; }
        .shop-details { font-size: 13px; color: #555; margin: 0; }
        
        .header-buttons { position: absolute; top: 0; right: 0; display: flex; gap: 5px; }
        .btn-history { background: #1976D2; color: white; border: none; padding: 6px 10px; border-radius: 5px; font-size: 12px; font-weight: bold; cursor: pointer; font-family: 'Noto Sans Telugu', sans-serif;}
        .btn-lock-change { background: #F57C00; }
        
        /* ‡∞ï‡∞∏‡±ç‡∞ü‡∞Æ‡∞∞‡±ç ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å */
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .input-group input { flex: 1; min-width: 45%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; font-family: 'Noto Sans Telugu', sans-serif;}
        .full-width { min-width: 100% !important; border: 2px solid #1976D2 !important;}
        
        .photo-upload { width: 100%; border: 1px dashed #D32F2F; padding: 10px; text-align: center; border-radius: 5px; background: #FFF8F8; color: #D32F2F; font-weight: bold; cursor: pointer;}
        
        /* ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å */
        .stages-box { border: 1px solid #ccc; padding: 10px; border-radius: 5px; background: #fafafa; margin-bottom: 15px; font-size: 14px; }
        .stage-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .stage-row input[type="date"] { padding: 3px; border: 1px solid #aaa; border-radius: 3px; font-family: inherit;}
        
        /* ‡∞ê‡∞ü‡∞Æ‡±ç‡∞∏‡±ç ‡∞™‡∞ü‡±ç‡∞ü‡∞ø‡∞ï */
        .table-header { display: flex; font-weight: bold; padding-bottom: 5px; border-bottom: 2px solid #ccc; margin-bottom: 10px; font-size: 14px;}
        .col-sel { width: 15%; text-align: center;} .col-name { width: 45%; } .col-qty, .col-price { width: 20%; text-align: center; }
        .item-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 14px; }
        .item-row input[type="number"], .item-row input[type="text"], .item-row input[type="password"] { width: 100%; padding: 5px; text-align: center; border: 1px solid #ccc; border-radius: 4px; font-family: inherit;}
        .item-row input[type="text"] { text-align: left; width: 95%; }
        .item-row input:disabled { background-color: #eee; opacity: 0.5; }
        
        /* ‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞ê‡∞ü‡∞Æ‡±ç ‡∞¨‡∞ü‡∞®‡±ç */
        .btn-add-custom { width: 100%; padding: 10px; background-color: #E3F2FD; color: #1976D2; border: 2px dashed #1976D2; border-radius: 8px; font-size: 15px; font-weight: bold; margin-bottom: 15px; cursor: pointer; font-family: inherit;}
        
        .btn-generate { width: 100%; padding: 15px; background-color: #D32F2F; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; margin-top: 5px; cursor: pointer; font-family: 'Noto Sans Telugu', sans-serif;}

        /* ‡∞™‡∞æ‡∞™‡±ç ‡∞Ö‡∞™‡±ç (Modal) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; width: 95%; max-width: 400px; border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; max-height: 95vh; }
        
        /* ‡∞¨‡∞ø‡∞≤‡±ç‡∞≤‡±Å ‡∞°‡∞ø‡∞ú‡±à‡∞®‡±ç (Receipt) */
        #receipt-content { background-color: #E1F5FE; padding: 15px; position: relative; color: #000; font-size: 14px; }
        #receipt-content::before { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: url('./watermark.png'); background-size: cover; background-position: center; opacity: 0.1; z-index: 0; }
        .receipt-inner { position: relative; z-index: 1; }
        .receipt-inner hr { border: 1px dashed #777; margin: 8px 0; }
        .total-line { font-size: 18px; font-weight: bold; color: #D32F2F; text-align: right; margin-top: 5px;}
        
        .cust-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .cust-photo-receipt { width: 60px; height: 60px; object-fit: cover; border: 2px solid #D32F2F; border-radius: 5px; display: none; }
        
        .r-stages { background: rgba(255,255,255,0.6); padding: 8px; border-radius: 5px; margin-top: 10px; border: 1px solid #ccc; }
        .r-stages div { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;}
        
        /* ‡∞∞‡±å‡∞Ç‡∞°‡±ç ‡∞ï‡∞≤‡∞∞‡±ç ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ï‡±Å‡∞≤‡±Å (‚úì ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å √ó) */
        .mark-yes, .mark-no { display: inline-flex; justify-content: center; align-items: center; width: 22px; height: 22px; border-radius: 50%; color: white; font-weight: bold; font-size: 14px; }
        .mark-yes { background-color: #2E7D32; } 
        .mark-no { background-color: #D32F2F; } 

        .modal-buttons { display: flex; padding: 10px; background: white; }
        .modal-buttons button { flex: 1; padding: 12px; margin: 5px; border: none; border-radius: 5px; font-weight: bold; font-size: 14px; font-family: 'Noto Sans Telugu', sans-serif;}
        .btn-close { background-color: #757575; color: white; }
        .btn-share { background-color: #2E7D32; color: white; }
        .btn-save { background-color: #1976D2; color: white; }
        
        /* ‡∞ö‡∞∞‡∞ø‡∞§‡±ç‡∞∞ ‡∞ú‡∞æ‡∞¨‡∞ø‡∞§‡∞æ */
        .hist-item { border-bottom: 1px solid #ccc; padding: 10px; font-size: 14px; }
        .hist-item strong { color: #D32F2F; }
    </style>
</head>
<body>

<div id="loader">
    <img src="./logo.png" id="main-loader-logo" alt="‡∞≤‡±ã‡∞°‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...">
    <h2 style="color: #D32F2F;">‡∞≤‡∞≤‡∞ø‡∞§ ‡∞∂‡±ç‡∞∞‡±Ä ‡∞ü‡±à‡∞≤‡∞∞‡±ç‡∞∏‡±ç</h2>
</div>

<div id="lock-screen">
    <div class="lock-box">
        <img src="./logo.png" style="max-height: 80px; margin-bottom: 10px;">
        <h2 style="color: #D32F2F; margin-top: 0;">‡∞Ø‡∞æ‡∞™‡±ç ‡∞≤‡∞æ‡∞ï‡±ç</h2>
        <p style="font-size: 13px; color: #555;">‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞™‡∞æ‡∞∏‡±ç‚Äå‡∞µ‡∞∞‡±ç‡∞°‡±ç (PIN) ‡∞é‡∞Ç‡∞ü‡∞∞‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø</p>
        <input type="password" id="loginPin" inputmode="numeric" pattern="[0-9]*" placeholder="****" maxlength="8">
        <button class="btn-unlock" onclick="unlockApp()">‡∞Ö‡∞®‡±ç‚Äå‡∞≤‡∞æ‡∞ï‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø</button>
    </div>
</div>

<div class="card">
    <div class="header">
        <div class="header-buttons">
            <button class="btn-history btn-lock-change" onclick="showPinChange()">‡∞≤‡∞æ‡∞ï‡±ç ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ö‡±Å</button>
            <button class="btn-history" onclick="showHistory()">‡∞™‡∞æ‡∞§ ‡∞¨‡∞ø‡∞≤‡±ç‡∞≤‡±Å‡∞≤‡±Å</button>
        </div>
        <img src="./logo.png" id="main-logo" alt="‡∞≤‡±ã‡∞ó‡±ã">
        <div class="shop-name">‡∞≤‡∞≤‡∞ø‡∞§ ‡∞∂‡±ç‡∞∞‡±Ä ‡∞ü‡±à‡∞≤‡∞∞‡±ç‡∞∏‡±ç</div>
        <p class="shop-details">‡∞∑‡∞æ‡∞™‡±ç ‡∞®‡±Ü‡∞Ç:30, ‡∞ï‡∞∞‡∞æ‡∞ö‡±Ä ‡∞∏‡±Ü‡∞Ç‡∞ü‡∞∞‡±ç, ‡∞Æ‡∞Ç‡∞°‡∞™‡±á‡∞ü<br>‡∞´‡±ã‡∞®‡±ç: 95023 84443</p>
    </div>

    <div class="input-group">
        <input type="text" id="billSerialNo" class="full-width" placeholder="‡∞¨‡∞ø‡∞≤‡±ç‡∞≤‡±Å ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç ‡∞∞‡∞æ‡∞Ø‡∞Ç‡∞°‡∞ø (‡∞â‡∞¶‡∞æ: 101)">
    </div>
    
    <div class="input-group">
        <input type="text" id="custName" placeholder="‡∞ï‡∞∏‡±ç‡∞ü‡∞Æ‡∞∞‡±ç ‡∞™‡±á‡∞∞‡±Å">
        <input type="tel" id="custMobile" placeholder="‡∞Æ‡±ä‡∞¨‡±à‡∞≤‡±ç ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç">
    </div>
    
    <div class="input-group">
        <label class="photo-upload">
            üì∏ ‡∞ï‡∞∏‡±ç‡∞ü‡∞Æ‡∞∞‡±ç ‡∞´‡±ã‡∞ü‡±ã ‡∞§‡±Ä‡∞Ø‡∞Ç‡∞°‡∞ø
            <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none;" onchange="loadPhoto(event)">
        </label>
        <div id="photoFileName" style="font-size: 12px; color: green; width: 100%; text-align: center;"></div>
    </div>

    <div class="stages-box">
        <strong>‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å:</strong>
        <div class="stage-row" style="margin-top: 8px;">
            <label>1. ‡∞¨‡±Å‡∞ï‡±ç ‡∞ö‡±á‡∞∏‡∞ø‡∞® ‡∞§‡±á‡∞¶‡±Ä:</label>
            <input type="date" id="dateBooked">
        </div>
        <div class="stage-row">
            <label><input type="checkbox" id="chkPaid"> 2. ‡∞°‡∞¨‡±ç‡∞¨‡±Å‡∞≤‡±Å ‡∞ö‡±Ü‡∞≤‡±ç‡∞≤‡∞ø‡∞Ç‡∞ö‡∞æ‡∞∞‡±Å</label>
            <input type="date" id="datePaid">
        </div>
        <div class="stage-row">
            <label><input type="checkbox" id="chkDelivered"> 3. ‡∞°‡±Ü‡∞≤‡∞ø‡∞µ‡∞∞‡±Ä ‡∞ö‡±á‡∞Ø‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø</label>
            <input type="date" id="dateDelivered">
        </div>
    </div>

    <div class="table-header">
        <div class="col-sel">‚úì</div><div class="col-name">‡∞ê‡∞ü‡∞Æ‡±ç</div><div class="col-qty">‡∞∏‡∞Ç‡∞ñ‡±ç‡∞Ø</div><div class="col-price">‡∞ß‡∞∞</div>
    </div>

    <div id="items-list"></div>
    
    <div id="custom-items-list"></div>
    
    <button class="btn-add-custom" onclick="addCustomItem()">+ ‡∞∏‡±ä‡∞Ç‡∞§‡∞Ç‡∞ó‡∞æ ‡∞ê‡∞ü‡∞Æ‡±ç ‡∞Ø‡∞æ‡∞°‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø</button>

    <button class="btn-generate" onclick="generateBill()">‡∞¨‡∞ø‡∞≤‡±ç‡∞≤‡±Å ‡∞§‡∞Ø‡∞æ‡∞∞‡±Å ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø</button>
</div>

<div id="receipt-modal" class="modal">
    <div class="modal-content">
        <div id="receipt-content">
            <div class="receipt-inner">
                <div style="text-align: center;">
                    <img id="receipt-logo-img" style="max-height: 60px;">
                    <h2 style="color: #D32F2F; margin: 5px 0;">‡∞≤‡∞≤‡∞ø‡∞§ ‡∞∂‡±ç‡∞∞‡±Ä ‡∞ü‡±à‡∞≤‡∞∞‡±ç‡∞∏‡±ç</h2>
                    <p style="margin:0; font-size: 11px;">‡∞∑‡∞æ‡∞™‡±ç ‡∞®‡±Ü‡∞Ç:30, ‡∞ï‡∞∞‡∞æ‡∞ö‡±Ä ‡∞∏‡±Ü‡∞Ç‡∞ü‡∞∞‡±ç, ‡∞Æ‡∞Ç‡∞°‡∞™‡±á‡∞ü | ‡∞´‡±ã‡∞®‡±ç: 95023 84443</p>
                </div>
                <hr>
                
                <div class="cust-header">
                    <div style="flex:1;">
                        <b>‡∞¨‡∞ø‡∞≤‡±ç‡∞≤‡±Å ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç:</b> <span id="r-serial" style="color:#D32F2F; font-size:16px; font-weight:bold;"></span><br>
                        <b>‡∞§‡±á‡∞¶‡±Ä:</b> <span id="r-date"></span><br>
                        <b>‡∞™‡±á‡∞∞‡±Å:</b> <span id="r-name"></span><br>
                        <b>‡∞Æ‡±ä‡∞¨‡±à‡∞≤‡±ç:</b> <span id="r-mobile"></span>
                    </div>
                    <img id="r-photo" class="cust-photo-receipt">
                </div>
                
                <hr>
                <table style="width: 100%; text-align: left; border-collapse: collapse; font-size: 13px;">
                    <thead><tr><th>‡∞ê‡∞ü‡∞Æ‡±ç</th><th>‡∞∏‡∞Ç‡∞ñ‡±ç‡∞Ø</th><th>‡∞ß‡∞∞</th></tr></thead>
                    <tbody id="r-items"></tbody>
                </table>
                <hr>
                <div class="total-line">‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç: ‡∞∞‡±Ç. <span id="r-total"></span></div>
                
                <div class="r-stages">
                    <div><span><b>‡∞¨‡±Å‡∞ï‡±ç ‡∞ö‡±á‡∞∏‡∞ø‡∞® ‡∞§‡±á‡∞¶‡±Ä:</b> <span id="r-s-booked"></span></span> <span class="mark-yes">‚úì</span></div>
                    <div><span><b>‡∞°‡∞¨‡±ç‡∞¨‡±Å‡∞≤‡±Å ‡∞ö‡±Ü‡∞≤‡±ç‡∞≤‡∞ø‡∞Ç‡∞ö‡∞æ‡∞∞‡±Å:</b> <span id="r-s-paid"></span></span> <span id="r-m-paid"></span></div>
                    <div><span><b>‡∞°‡±Ü‡∞≤‡∞ø‡∞µ‡∞∞‡±Ä ‡∞ö‡±á‡∞Ø‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø:</b> <span id="r-s-del"></span></span> <span id="r-m-del"></span></div>
                </div>
                
                <p style="text-align: center; font-style: italic; font-size: 12px; margin-top:10px;">‡∞ß‡∞®‡±ç‡∞Ø‡∞µ‡∞æ‡∞¶‡∞æ‡∞≤‡±Å! ‡∞Æ‡∞≥‡±ç‡∞≥‡±Ä ‡∞∞‡∞Ç‡∞°‡∞ø.</p>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="btn-close" onclick="closeModal('receipt-modal')">‡∞Æ‡±Ç‡∞∏‡∞ø‡∞µ‡±á‡∞Ø‡±Å</button>
            <button class="btn-share" onclick="shareReceipt()">‡∞∑‡±á‡∞∞‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø</button>
        </div>
    </div>
</div>

<div id="history-modal" class="modal">
    <div class="modal-content" style="background: white; padding: 15px;">
        <h3 style="color: #D32F2F; margin-top: 0;">‡∞™‡∞æ‡∞§ ‡∞¨‡∞ø‡∞≤‡±ç‡∞≤‡±Å‡∞≤‡±Å</h3>
        <div id="history-list" style="overflow-y: auto; flex: 1; max-height: 60vh;"></div>
        <button class="btn-close" style="width: 100%; padding: 15px; margin-top: 10px;" onclick="closeModal('history-modal')">‡∞Æ‡±Ç‡∞∏‡∞ø‡∞µ‡±á‡∞Ø‡±Å</button>
    </div>
</div>

<div id="pin-modal" class="modal">
    <div class="modal-content" style="background: white; padding: 20px;">
        <h3 style="color: #D32F2F; margin-top: 0; text-align: center;">‡∞™‡∞æ‡∞∏‡±ç‚Äå‡∞µ‡∞∞‡±ç‡∞°‡±ç ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ö‡∞Ç‡∞°‡∞ø</h3>
        <input type="password" id="oldPin" inputmode="numeric" pattern="[0-9]*" placeholder="‡∞™‡∞æ‡∞§ ‡∞™‡∞æ‡∞∏‡±ç‚Äå‡∞µ‡∞∞‡±ç‡∞°‡±ç" style="width: 90%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;">
        <input type="password" id="newPin" inputmode="numeric" pattern="[0-9]*" placeholder="‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞™‡∞æ‡∞∏‡±ç‚Äå‡∞µ‡∞∞‡±ç‡∞°‡±ç (PIN)" style="width: 90%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;">
        <input type="password" id="confPin" inputmode="numeric" pattern="[0-9]*" placeholder="‡∞Æ‡∞≥‡±ç‡∞≥‡±Ä ‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞™‡∞æ‡∞∏‡±ç‚Äå‡∞µ‡∞∞‡±ç‡∞°‡±ç ‡∞∞‡∞æ‡∞Ø‡∞Ç‡∞°‡∞ø" style="width: 90%; padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 5px;">
        
        <div class="modal-buttons" style="padding: 0;">
            <button class="btn-close" onclick="closeModal('pin-modal')">‡∞∞‡∞¶‡±ç‡∞¶‡±Å ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø</button>
            <button class="btn-save" onclick="saveNewPin()">‡∞∏‡±á‡∞µ‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø</button>
        </div>
    </div>
</div>

<script>
    let logoBase64 = "";
    let customItemCount = 0; 
    
    window.onload = () => {
        // ‡∞≤‡±ã‡∞°‡∞ø‡∞Ç‡∞ó‡±ç ‡∞∏‡±ç‡∞ï‡±ç‡∞∞‡±Ä‡∞®‡±ç ‡∞π‡±à‡∞°‡±ç ‡∞ö‡±á‡∞Ø‡∞°‡∞Ç
        setTimeout(() => {
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
        }, 1500);
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dateBooked').value = today;

        const img = new Image();
        img.src = "./logo.png";
        img.onload = function() {
            const canvas = document.createElement("canvas");
            canvas.width = img.width; canvas.height = img.height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);
            logoBase64 = canvas.toDataURL("image/png");
            document.getElementById('receipt-logo-img').src = logoBase64;
        };
    };

    // --- ‡∞Ø‡∞æ‡∞™‡±ç ‡∞≤‡∞æ‡∞ï‡±ç (App Lock) ‡∞∏‡∞ø‡∞∏‡±ç‡∞ü‡∞Æ‡±ç ---
    function unlockApp() {
        const enteredPin = document.getElementById('loginPin').value;
        const savedPin = localStorage.getItem('appPin') || '4443'; // ‡∞°‡∞ø‡∞´‡∞æ‡∞≤‡±ç‡∞ü‡±ç ‡∞™‡∞æ‡∞∏‡±ç‡∞µ‡∞∞‡±ç‡∞°‡±ç: 4443
        
        if(enteredPin === savedPin) {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('loginPin').value = '';
        } else {
            alert("‡∞™‡∞æ‡∞∏‡±ç‚Äå‡∞µ‡∞∞‡±ç‡∞°‡±ç ‡∞§‡∞™‡±ç‡∞™‡±Å! ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Æ‡∞≥‡±ç‡∞≥‡±Ä ‡∞™‡±ç‡∞∞‡∞Ø‡∞§‡±ç‡∞®‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø.");
            document.getElementById('loginPin').value = '';
        }
    }

    function showPinChange() {
        document.getElementById('pin-modal').style.display = 'flex';
    }

    function saveNewPin() {
        const oldP = document.getElementById('oldPin').value;
        const newP = document.getElementById('newPin').value;
        const confP = document.getElementById('confPin').value;
        const savedPin = localStorage.getItem('appPin') || '4443';

        if(oldP !== savedPin) {
            alert("‡∞™‡∞æ‡∞§ ‡∞™‡∞æ‡∞∏‡±ç‚Äå‡∞µ‡∞∞‡±ç‡∞°‡±ç ‡∞§‡∞™‡±ç‡∞™‡±Å ‡∞é‡∞Ç‡∞ü‡∞∞‡±ç ‡∞ö‡±á‡∞∏‡∞æ‡∞∞‡±Å!");
            return;
        }
        if(newP === "" || newP.length < 4) {
            alert("‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞™‡∞æ‡∞∏‡±ç‚Äå‡∞µ‡∞∞‡±ç‡∞°‡±ç ‡∞ï‡∞®‡±Ä‡∞∏‡∞Ç 4 ‡∞Ö‡∞Ç‡∞ï‡±Ü‡∞≤‡±Å ‡∞â‡∞Ç‡∞°‡∞æ‡∞≤‡∞ø!");
            return;
        }
        if(newP !== confP) {
            alert("‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞™‡∞æ‡∞∏‡±ç‚Äå‡∞µ‡∞∞‡±ç‡∞°‡±ç ‡∞∞‡±Ü‡∞Ç‡∞°‡±Å ‡∞∏‡∞æ‡∞∞‡±ç‡∞≤‡±Å ‡∞í‡∞ï‡±á‡∞≤‡∞æ ‡∞≤‡±á‡∞¶‡±Å!");
            return;
        }
        
        localStorage.setItem('appPin', newP);
        alert("‡∞™‡∞æ‡∞∏‡±ç‚Äå‡∞µ‡∞∞‡±ç‡∞°‡±ç ‡∞µ‡∞ø‡∞ú‡∞Ø‡∞µ‡∞Ç‡∞§‡∞Ç‡∞ó‡∞æ ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø!");
        closeModal('pin-modal');
    }
    // ------------------------------------

    const items = ["‡∞™‡±Ü‡∞¶‡±ç‡∞¶ ‡∞∑‡∞∞‡±ç‡∞ü‡±ç", "‡∞™‡±Ü‡∞¶‡±ç‡∞¶ ‡∞´‡±ç‡∞Ø‡∞æ‡∞Ç‡∞ü‡±Å", "‡∞™‡±Ü‡∞¶‡±ç‡∞¶ ‡∞®‡∞ø‡∞ï‡±ç‡∞ï‡∞∞‡±ç", "‡∞ï‡±Å‡∞∞‡±ç‡∞§‡∞æ", "‡∞∏‡±ç‡∞ï‡±Ç‡∞≤‡±ç ‡∞Ø‡±Ç‡∞®‡∞ø‡∞´‡∞æ‡∞Æ‡±ç", "‡∞ö‡∞ø‡∞®‡±ç‡∞® ‡∞∑‡∞∞‡±ç‡∞ü‡±Å", "‡∞ö‡∞ø‡∞®‡±ç‡∞® ‡∞´‡±ç‡∞Ø‡∞æ‡∞Ç‡∞ü‡±Å", "‡∞ö‡∞ø‡∞®‡±ç‡∞® ‡∞®‡∞ø‡∞ï‡±ç‡∞ï‡∞∞‡±ç", "‡∞á‡∞§‡∞∞ ‡∞Ü‡∞≤‡±ç‡∞ü‡∞∞‡±á‡∞∑‡∞®‡±ç‡∞∏‡±ç"];
    const listDiv = document.getElementById('items-list');
    let currentPhotoBase64 = "";
    
    // ‡∞°‡∞ø‡∞´‡∞æ‡∞≤‡±ç‡∞ü‡±ç ‡∞ê‡∞ü‡∞Æ‡±ç‡∞∏‡±ç
    items.forEach((item, index) => {
        listDiv.innerHTML += `
            <div class="item-row">
                <div class="col-sel"><input type="checkbox" id="chk${index}" onchange="toggleItem(${index})"></div>
                <div class="col-name"><label for="chk${index}">${item}</label></div>
                <div class="col-qty"><input type="number" id="qty${index}" value="1" disabled></div>
                <div class="col-price"><input type="number" id="rate${index}" placeholder="0" disabled></div>
            </div>`;
    });

    function toggleItem(index) {
        const isChecked = document.getElementById(`chk${index}`).checked;
        document.getElementById(`qty${index}`).disabled = !isChecked;
        document.getElementById(`rate${index}`).disabled = !isChecked;
    }

    // ‡∞∏‡±ä‡∞Ç‡∞§‡∞Ç‡∞ó‡∞æ ‡∞ê‡∞ü‡∞Æ‡±ç ‡∞Ø‡∞æ‡∞°‡±ç ‡∞ö‡±á‡∞∏‡±á ‡∞´‡∞Ç‡∞ï‡±ç‡∞∑‡∞®‡±ç
    function addCustomItem() {
        const container = document.getElementById('custom-items-list');
        const cId = customItemCount++;
        
        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `
            <div class="col-sel"><input type="checkbox" id="c_chk${cId}" checked onchange="toggleCustomItem(${cId})"></div>
            <div class="col-name"><input type="text" id="c_name${cId}" placeholder="‡∞ê‡∞ü‡∞Æ‡±ç ‡∞™‡±á‡∞∞‡±Å (‡∞ü‡±à‡∞™‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø)"></div>
            <div class="col-qty"><input type="number" id="c_qty${cId}" value="1"></div>
            <div class="col-price"><input type="number" id="c_rate${cId}" placeholder="‡∞ß‡∞∞"></div>
        `;
        container.appendChild(div);
    }

    function toggleCustomItem(id) {
        const isChecked = document.getElementById(`c_chk${id}`).checked;
        document.getElementById(`c_name${id}`).disabled = !isChecked;
        document.getElementById(`c_qty${id}`).disabled = !isChecked;
        document.getElementById(`c_rate${id}`).disabled = !isChecked;
    }

    function loadPhoto(event) {
        const file = event.target.files[0];
        if (file) {
            document.getElementById('photoFileName').innerText = "‚úì ‡∞´‡±ã‡∞ü‡±ã ‡∞Ø‡∞æ‡∞°‡±ç ‡∞ö‡±á‡∞Ø‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø!";
            const reader = new FileReader();
            reader.onload = function(e) { currentPhotoBase64 = e.target.result; }
            reader.readAsDataURL(file);
        }
    }

    function generateBill() {
        const serialInput = document.getElementById('billSerialNo').value;
        if (!serialInput) { alert("‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Æ‡±Å‡∞Ç‡∞¶‡±Å‡∞ó‡∞æ '‡∞¨‡∞ø‡∞≤‡±ç‡∞≤‡±Å ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç' ‡∞∞‡∞æ‡∞Ø‡∞Ç‡∞°‡∞ø!"); return; }

        let total = 0; let itemsHtml = ""; let hasItems = false;

        // 1. ‡∞°‡∞ø‡∞´‡∞æ‡∞≤‡±ç‡∞ü‡±ç ‡∞ê‡∞ü‡∞Æ‡±ç‡∞∏‡±ç
        items.forEach((item, index) => {
            if (document.getElementById(`chk${index}`).checked) {
                const q = parseFloat(document.getElementById(`qty${index}`).value) || 0;
                const r = parseFloat(document.getElementById(`rate${index}`).value) || 0;
                const amt = q * r;
                if (amt > 0) {
                    hasItems = true; total += amt;
                    itemsHtml += `<tr><td>${item}</td><td>${q}</td><td>‡∞∞‡±Ç.${amt}</td></tr>`;
                }
            }
        });

        // 2. ‡∞∏‡±ä‡∞Ç‡∞§‡∞Ç‡∞ó‡∞æ ‡∞Ø‡∞æ‡∞°‡±ç ‡∞ö‡±á‡∞∏‡∞ø‡∞® (Custom) ‡∞ê‡∞ü‡∞Æ‡±ç‡∞∏‡±ç
        for(let i=0; i<customItemCount; i++) {
            const chk = document.getElementById(`c_chk${i}`);
            if(chk && chk.checked) {
                const name = document.getElementById(`c_name${i}`).value || "‡∞á‡∞§‡∞∞ ‡∞ê‡∞ü‡∞Æ‡±ç";
                const q = parseFloat(document.getElementById(`c_qty${i}`).value) || 0;
                const r = parseFloat(document.getElementById(`c_rate${i}`).value) || 0;
                const amt = q * r;
                if(amt > 0) {
                    hasItems = true; total += amt;
                    itemsHtml += `<tr><td>${name}</td><td>${q}</td><td>‡∞∞‡±Ç.${amt}</td></tr>`;
                }
            }
        }

        if (!hasItems) { alert("‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞ï‡∞®‡±Ä‡∞∏‡∞Ç ‡∞í‡∞ï ‡∞ê‡∞ü‡∞Æ‡±ç ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø."); return; }

        const name = document.getElementById('custName').value || "-";
        const mobile = document.getElementById('custMobile').value || "-";
        
        document.getElementById('r-serial').innerText = serialInput;
        document.getElementById('r-name').innerText = name;
        document.getElementById('r-mobile').innerText = mobile;
        
        const now = new Date();
        document.getElementById('r-date').innerText = now.toLocaleDateString('en-IN') + " " + now.toLocaleTimeString('en-IN', {hour: '2-digit', minute:'2-digit'});
        
        const photoImg = document.getElementById('r-photo');
        if (currentPhotoBase64) {
            photoImg.src = currentPhotoBase64;
            photoImg.style.display = 'block';
        } else {
            photoImg.style.display = 'none';
        }

        document.getElementById('r-items').innerHTML = itemsHtml;
        document.getElementById('r-total').innerText = total;

        document.getElementById('r-s-booked').innerText = formatDate(document.getElementById('dateBooked').value);
        
        const isPaid = document.getElementById('chkPaid').checked;
        document.getElementById('r-s-paid').innerText = isPaid ? formatDate(document.getElementById('datePaid').value) : "‡∞™‡±Ü‡∞Ç‡∞°‡∞ø‡∞Ç‡∞ó‡±ç";
        document.getElementById('r-m-paid').className = isPaid ? "mark-yes" : "mark-no";
        document.getElementById('r-m-paid').innerText = isPaid ? "‚úì" : "√ó";

        const isDel = document.getElementById('chkDelivered').checked;
        document.getElementById('r-s-del').innerText = isDel ? formatDate(document.getElementById('dateDelivered').value) : "‡∞™‡±Ü‡∞Ç‡∞°‡∞ø‡∞Ç‡∞ó‡±ç";
        document.getElementById('r-m-del').className = isDel ? "mark-yes" : "mark-no";
        document.getElementById('r-m-del').innerText = isDel ? "‚úì" : "√ó";

        saveToHistory(serialInput, name, total);

        document.getElementById('receipt-modal').style.display = 'flex';
    }

    function formatDate(dateStr) {
        if(!dateStr) return "";
        const p = dateStr.split('-');
        return `${p[2]}-${p[1]}-${p[0]}`;
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
        
        if(id === 'receipt-modal') resetForm();
        
        if(id === 'pin-modal') {
            document.getElementById('oldPin').value = '';
            document.getElementById('newPin').value = '';
            document.getElementById('confPin').value = '';
        }
    }

    function resetForm() {
        document.getElementById('billSerialNo').value = "";
        document.getElementById('custName').value = "";
        document.getElementById('custMobile').value = "";
        document.getElementById('chkPaid').checked = false;
        document.getElementById('chkDelivered').checked = false;
        document.getElementById('datePaid').value = "";
        document.getElementById('dateDelivered').value = "";
        document.getElementById('photoInput').value = "";
        document.getElementById('photoFileName').innerText = "";
        currentPhotoBase64 = "";
        
        // ‡∞°‡∞ø‡∞´‡∞æ‡∞≤‡±ç‡∞ü‡±ç ‡∞ê‡∞ü‡∞Æ‡±ç‡∞∏‡±ç ‡∞∞‡±Ä‡∞∏‡±Ü‡∞ü‡±ç
        items.forEach((_, i) => {
            document.getElementById(`chk${i}`).checked = false;
            toggleItem(i);
            document.getElementById(`rate${i}`).value = "";
            document.getElementById(`qty${i}`).value = "1";
        });

        // ‡∞ï‡±ä‡∞§‡±ç‡∞§‡∞ó‡∞æ ‡∞Ø‡∞æ‡∞°‡±ç ‡∞ö‡±á‡∞∏‡∞ø‡∞® ‡∞ê‡∞ü‡∞Æ‡±ç‡∞∏‡±ç ‡∞Ö‡∞®‡±ç‡∞®‡±Ä ‡∞§‡±Å‡∞°‡∞ø‡∞ö‡∞ø‡∞µ‡±á‡∞Ø‡∞°‡∞Ç
        document.getElementById('custom-items-list').innerHTML = "";
        customItemCount = 0;
    }

    async function shareReceipt() {
        alert("‡∞ó‡∞Æ‡∞®‡∞ø‡∞ï:\n\n‡∞¶‡∞∂ 1: ‡∞Æ‡±Å‡∞Ç‡∞¶‡±Å‡∞ó‡∞æ ‡∞à ‡∞¨‡∞ø‡∞≤‡±ç‡∞≤‡±Å‡∞®‡∞ø ‡∞Æ‡±Ä ‡∞´‡±ã‡∞®‡±ç ‡∞ó‡±ç‡∞Ø‡∞æ‡∞≤‡∞∞‡±Ä ‡∞≤‡±á‡∞¶‡∞æ ‡∞°‡±ç‡∞∞‡±à‡∞µ‡±ç ‡∞≤‡±ã ‡∞∏‡±á‡∞µ‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø.\n‡∞¶‡∞∂ 2: ‡∞Ü ‡∞§‡∞∞‡±ç‡∞µ‡∞æ‡∞§ ‡∞ï‡∞∏‡±ç‡∞ü‡∞Æ‡∞∞‡±ç ‡∞ï‡∞ø WhatsApp ‡∞≤‡±ã ‡∞∑‡±á‡∞∞‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø.");

        const receiptDiv = document.getElementById('receipt-content');
        const canvas = await html2canvas(receiptDiv, { scale: 2, useCORS: true });
        const base64Image = canvas.toDataURL("image/png");

        if (window.plugins && window.plugins.socialsharing) {
            window.plugins.socialsharing.share('‡∞Æ‡±Ä ‡∞¨‡∞ø‡∞≤‡±ç‡∞≤‡±Å ‡∞á‡∞ï‡±ç‡∞ï‡∞° ‡∞â‡∞Ç‡∞¶‡∞ø. ‡∞ß‡∞®‡±ç‡∞Ø‡∞µ‡∞æ‡∞¶‡∞æ‡∞≤‡±Å!', '‡∞≤‡∞≤‡∞ø‡∞§ ‡∞∂‡±ç‡∞∞‡±Ä ‡∞ü‡±à‡∞≤‡∞∞‡±ç‡∞∏‡±ç - ‡∞¨‡∞ø‡∞≤‡±ç‡∞≤‡±Å', base64Image, null);
        } else {
            canvas.toBlob(async (blob) => {
                const file = new File([blob], 'bill.png', { type: 'image/png' });
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: '‡∞¨‡∞ø‡∞≤‡±ç‡∞≤‡±Å', text: '‡∞Æ‡±Ä ‡∞¨‡∞ø‡∞≤‡±ç‡∞≤‡±Å ‡∞á‡∞ï‡±ç‡∞ï‡∞° ‡∞â‡∞Ç‡∞¶‡∞ø' });
                }
            });
        }
    }

    function saveToHistory(serial, name, total) {
        let history = JSON.parse(localStorage.getItem("tailorHistory")) || [];
        const date = new Date().toLocaleDateString('en-IN');
        history.unshift({ serial, name, total, date });
        if (history.length > 50) history.pop();
        localStorage.setItem("tailorHistory", JSON.stringify(history));
    }

    function showHistory() {
        const list = document.getElementById('history-list');
        let history = JSON.parse(localStorage.getItem("tailorHistory")) || [];
        if (history.length === 0) {
            list.innerHTML = "<p>‡∞™‡∞æ‡∞§ ‡∞¨‡∞ø‡∞≤‡±ç‡∞≤‡±Å‡∞≤‡±Å ‡∞è‡∞Æ‡±Ä ‡∞≤‡±á‡∞µ‡±Å.</p>";
        } else {
            list.innerHTML = history.map(h => 
                `<div class="hist-item">
                    <strong>${h.date}</strong> | ‡∞¨‡∞ø‡∞≤‡±ç‡∞≤‡±Å ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç: ${h.serial} <br>
                    ‡∞™‡±á‡∞∞‡±Å: ${h.name} | <b>‡∞∞‡±Ç. ${h.total}</b>
                </div>`
            ).join('');
        }
        document.getElementById('history-modal').style.display = 'flex';
    }
</script>
</body>
    </html>
